name: Validar Exerc√≠cio - Aula 01

on:
  pull_request:
    paths:
      - 'exercicios/aula01/**'
  push:
    branches:
      - main
    paths:
      - 'exercicios/aula01/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
      
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Verificar estrutura do projeto
        id: check-structure
        run: |
          echo "üîç Verificando estrutura do projeto Android..."
          SCORE=0
          ERRORS=""
          PROJECT_PATH="exercicios/aula01/HelloMobile"
          
          echo "## üìä Valida√ß√£o Autom√°tica - Aula 01" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se pasta HelloMobile existe
          if [ -d "$PROJECT_PATH" ]; then
            echo "‚úÖ Pasta HelloMobile encontrada"
            echo "‚úÖ Pasta HelloMobile encontrada" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå Pasta HelloMobile n√£o encontrada"
            echo "‚ùå Pasta HelloMobile n√£o encontrada" >> $GITHUB_STEP_SUMMARY
            ERRORS="${ERRORS}\n- Crie o projeto com nome HelloMobile"
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ùå Score Final: $SCORE/100" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** REPROVADO (m√≠nimo 70/100)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Verificar MainActivity.kt
          MAIN_ACTIVITY=$(find $PROJECT_PATH -name "MainActivity.kt" | head -1)
          if [ -f "$MAIN_ACTIVITY" ]; then
            echo "‚úÖ MainActivity.kt encontrada"
            echo "‚úÖ MainActivity.kt encontrada" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE + 10))
            
            # Verificar package name
            if grep -q "package com\." "$MAIN_ACTIVITY"; then
              echo "‚úÖ Package name correto"
              echo "‚úÖ Package name correto" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 5))
            else
              echo "‚ùå Package name incorreto"
              echo "‚ùå Package name incorreto" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Package name deve come√ßar com com.seuusername"
            fi
            
            # Verificar array de cores
            if grep -q "Color.parseColor" "$MAIN_ACTIVITY"; then
              echo "‚úÖ Array de cores encontrado"
              echo "‚úÖ Array de cores encontrado" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå Array de cores n√£o encontrado"
              echo "‚ùå Array de cores n√£o encontrado" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Adicione array com Color.parseColor"
            fi
            
            # Verificar findViewById
            if grep -q "findViewById" "$MAIN_ACTIVITY"; then
              echo "‚úÖ findViewById implementado"
              echo "‚úÖ findViewById implementado" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå findViewById n√£o encontrado"
              echo "‚ùå findViewById n√£o encontrado" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Use findViewById para pegar as views"
            fi
            
            # Verificar setOnClickListener
            if grep -q "setOnClickListener" "$MAIN_ACTIVITY"; then
              echo "‚úÖ setOnClickListener implementado"
              echo "‚úÖ setOnClickListener implementado" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå setOnClickListener n√£o encontrado"
              echo "‚ùå setOnClickListener n√£o encontrado" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Adicione setOnClickListener no bot√£o"
            fi
            
            # Verificar setBackgroundColor
            if grep -q "setBackgroundColor" "$MAIN_ACTIVITY"; then
              echo "‚úÖ setBackgroundColor implementado"
              echo "‚úÖ setBackgroundColor implementado" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå setBackgroundColor n√£o encontrado"
              echo "‚ùå setBackgroundColor n√£o encontrado" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Use setBackgroundColor para mudar cor"
            fi
          else
            echo "‚ùå MainActivity.kt n√£o encontrada"
            echo "‚ùå MainActivity.kt n√£o encontrada" >> $GITHUB_STEP_SUMMARY
            ERRORS="${ERRORS}\n- Crie MainActivity.kt"
          fi
          
          # Verificar activity_main.xml
          LAYOUT_XML=$(find $PROJECT_PATH -path "*/layout/activity_main.xml" | head -1)
          if [ -f "$LAYOUT_XML" ]; then
            echo "‚úÖ activity_main.xml encontrado"
            echo "‚úÖ activity_main.xml encontrado" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE + 10))
            
            # Verificar LinearLayout com id
            if grep -q 'android:id="@+id/rootLayout"' "$LAYOUT_XML"; then
              echo "‚úÖ LinearLayout com id correto"
              echo "‚úÖ LinearLayout com id correto" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 5))
            else
              echo "‚ùå LinearLayout sem id rootLayout"
              echo "‚ùå LinearLayout sem id rootLayout" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- LinearLayout precisa ter id rootLayout"
            fi
            
            # Verificar TextViews
            TV_COUNT=$(grep -c '<TextView' "$LAYOUT_XML" || echo "0")
            if [ "$TV_COUNT" -ge 3 ]; then
              echo "‚úÖ 3+ TextViews encontrados"
              echo "‚úÖ 3+ TextViews encontrados" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 5))
            else
              echo "‚ùå Menos de 3 TextViews"
              echo "‚ùå Menos de 3 TextViews" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Adicione pelo menos 3 TextViews"
            fi
            
            # Verificar Button com id
            if grep -q 'android:id="@+id/btnMudarCor"' "$LAYOUT_XML"; then
              echo "‚úÖ Button com id correto"
              echo "‚úÖ Button com id correto" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 5))
            else
              echo "‚ùå Button sem id btnMudarCor"
              echo "‚ùå Button sem id btnMudarCor" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Button precisa ter id btnMudarCor"
            fi
            
            # Verificar personaliza√ß√£o
            if ! grep -q 'Seu Nome' "$LAYOUT_XML" && ! grep -q 'Matr√≠cula:' "$LAYOUT_XML"; then
              echo "‚úÖ Conte√∫do personalizado"
              echo "‚úÖ Conte√∫do personalizado" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå Conte√∫do n√£o personalizado"
              echo "‚ùå Conte√∫do n√£o personalizado" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Personalize os TextViews com seu nome"
            fi
          else
            echo "‚ùå activity_main.xml n√£o encontrado"
            echo "‚ùå activity_main.xml n√£o encontrado" >> $GITHUB_STEP_SUMMARY
            ERRORS="${ERRORS}\n- Crie activity_main.xml no res/layout"
          fi
          
          # Verificar build.gradle
          BUILD_GRADLE=$(find $PROJECT_PATH -name "build.gradle*" | head -1)
          if [ -f "$BUILD_GRADLE" ]; then
            if grep -q "minSdk.*24" "$BUILD_GRADLE" || grep -q "minSdkVersion 24" "$BUILD_GRADLE"; then
              echo "‚úÖ MinSDK 24 configurado"
              echo "‚úÖ MinSDK 24 configurado" >> $GITHUB_STEP_SUMMARY
              SCORE=$((SCORE + 5))
            else
              echo "‚ùå MinSDK diferente de 24"
              echo "‚ùå MinSDK diferente de 24" >> $GITHUB_STEP_SUMMARY
              ERRORS="${ERRORS}\n- Configure minSdk = 24"
            fi
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Score Final: **$SCORE/100**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $SCORE -ge 90 ]; then
            echo "**Status:** ‚úÖ EXCELENTE (90+)" >> $GITHUB_STEP_SUMMARY
            echo "üéâ Perfeito! Voc√™ dominou os conceitos!" >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 70 ]; then
            echo "**Status:** ‚úÖ APROVADO (70-89)" >> $GITHUB_STEP_SUMMARY
            echo "üëç Bom trabalho! Exerc√≠cio aprovado." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚ùå REPROVADO (< 70)" >> $GITHUB_STEP_SUMMARY
            echo "üìù Corrija os problemas e tente novamente." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìö Recursos" >> $GITHUB_STEP_SUMMARY
          echo "- [Documenta√ß√£o Android](https://developer.android.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Slides Aula 01](https://github.com/petrosbarreto/desenvolvimento-mobile-2026)" >> $GITHUB_STEP_SUMMARY
          echo "- [README do Exerc√≠cio](https://github.com/petrosbarreto/desenvolvimento-mobile-2026-exercicios/tree/main/exercicios/aula01)" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "========================================="
          echo "üìä SCORE FINAL: $SCORE/100"
          echo "========================================="
      
      - name: Definir status do check
        if: steps.check-structure.outputs.score < 70
        run: |
          echo "‚ùå Score abaixo de 70/100. Exerc√≠cio REPROVADO."
          echo "Veja o resumo acima para detalhes."
          exit 1
