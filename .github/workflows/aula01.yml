name: Validar Exerc√≠cio - Aula 01

on:
  pull_request:
    paths:
      - 'exercicios/aula01/**'
  push:
    branches:
      - main
    paths:
      - 'exercicios/aula01/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
      
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Verificar estrutura do projeto
        id: check-structure
        run: |
          echo "üîç Verificando estrutura do projeto Android..."
          SCORE=0
          ERRORS=""
          PROJECT_PATH="exercicios/aula01/HelloMobile"
          
          # Verificar se pasta HelloMobile existe
          if [ -d "$PROJECT_PATH" ]; then
            echo "‚úÖ Pasta HelloMobile encontrada"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå Pasta HelloMobile n√£o encontrada"
            ERRORS="${ERRORS}\n- Crie o projeto com nome HelloMobile"
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "errors<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ERRORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Verificar MainActivity.kt
          MAIN_ACTIVITY=$(find $PROJECT_PATH -name "MainActivity.kt" | head -1)
          if [ -f "$MAIN_ACTIVITY" ]; then
            echo "‚úÖ MainActivity.kt encontrada"
            SCORE=$((SCORE + 10))
            
            # Verificar package name
            if grep -q "package com\." "$MAIN_ACTIVITY"; then
              echo "‚úÖ Package name correto"
              SCORE=$((SCORE + 5))
            else
              ERRORS="${ERRORS}\n- Package name deve come√ßar com com.seuusername"
            fi
            
            # Verificar array de cores
            if grep -q "Color.parseColor" "$MAIN_ACTIVITY"; then
              echo "‚úÖ Array de cores encontrado"
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå Array de cores n√£o encontrado"
              ERRORS="${ERRORS}\n- Adicione array com Color.parseColor"
            fi
            
            # Verificar findViewById
            if grep -q "findViewById" "$MAIN_ACTIVITY"; then
              echo "‚úÖ findViewById implementado"
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå findViewById n√£o encontrado"
              ERRORS="${ERRORS}\n- Use findViewById para pegar as views"
            fi
            
            # Verificar setOnClickListener
            if grep -q "setOnClickListener" "$MAIN_ACTIVITY"; then
              echo "‚úÖ setOnClickListener implementado"
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå setOnClickListener n√£o encontrado"
              ERRORS="${ERRORS}\n- Adicione setOnClickListener no bot√£o"
            fi
            
            # Verificar setBackgroundColor
            if grep -q "setBackgroundColor" "$MAIN_ACTIVITY"; then
              echo "‚úÖ setBackgroundColor implementado"
              SCORE=$((SCORE + 10))
            else
              echo "‚ùå setBackgroundColor n√£o encontrado"
              ERRORS="${ERRORS}\n- Use setBackgroundColor para mudar cor"
            fi
          else
            echo "‚ùå MainActivity.kt n√£o encontrada"
            ERRORS="${ERRORS}\n- Crie MainActivity.kt"
          fi
          
          # Verificar activity_main.xml
          LAYOUT_XML=$(find $PROJECT_PATH -path "*/layout/activity_main.xml" | head -1)
          if [ -f "$LAYOUT_XML" ]; then
            echo "‚úÖ activity_main.xml encontrado"
            SCORE=$((SCORE + 10))
            
            # Verificar LinearLayout com id
            if grep -q 'android:id="@+id/rootLayout"' "$LAYOUT_XML"; then
              echo "‚úÖ LinearLayout com id correto"
              SCORE=$((SCORE + 5))
            else
              ERRORS="${ERRORS}\n- LinearLayout precisa ter id rootLayout"
            fi
            
            # Verificar TextViews
            TV_COUNT=$(grep -c '<TextView' "$LAYOUT_XML" || echo "0")
            if [ "$TV_COUNT" -ge 3 ]; then
              echo "‚úÖ 3+ TextViews encontrados"
              SCORE=$((SCORE + 5))
            else
              ERRORS="${ERRORS}\n- Adicione pelo menos 3 TextViews"
            fi
            
            # Verificar Button com id
            if grep -q 'android:id="@+id/btnMudarCor"' "$LAYOUT_XML"; then
              echo "‚úÖ Button com id correto"
              SCORE=$((SCORE + 5))
            else
              ERRORS="${ERRORS}\n- Button precisa ter id btnMudarCor"
            fi
            
            # Verificar personaliza√ß√£o
            if ! grep -q 'Seu Nome' "$LAYOUT_XML" && ! grep -q 'Matr√≠cula:' "$LAYOUT_XML"; then
              echo "‚úÖ Conte√∫do personalizado"
              SCORE=$((SCORE + 10))
            else
              ERRORS="${ERRORS}\n- Personalize os TextViews com seu nome"
            fi
          else
            echo "‚ùå activity_main.xml n√£o encontrado"
            ERRORS="${ERRORS}\n- Crie activity_main.xml no res/layout"
          fi
          
          # Verificar build.gradle
          BUILD_GRADLE=$(find $PROJECT_PATH -name "build.gradle*" | head -1)
          if [ -f "$BUILD_GRADLE" ]; then
            if grep -q "minSdk.*24" "$BUILD_GRADLE" || grep -q "minSdkVersion 24" "$BUILD_GRADLE"; then
              echo "‚úÖ MinSDK 24 configurado"
              SCORE=$((SCORE + 5))
            else
              ERRORS="${ERRORS}\n- Configure minSdk = 24"
            fi
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üìä SCORE: $SCORE/100"
      
      - name: Tentar compilar o projeto (opcional)
        id: build-project
        continue-on-error: true
        run: |
          PROJECT_PATH="exercicios/aula01/HelloMobile"
          if [ -d "$PROJECT_PATH" ] && [ -f "$PROJECT_PATH/gradlew" ]; then
            echo "üî® Tentando compilar o projeto..."
            cd $PROJECT_PATH
            chmod +x gradlew
            ./gradlew assembleDebug --no-daemon --stacktrace || echo "build_failed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Projeto n√£o tem gradlew, pulando compila√ß√£o"
          fi
      
      - name: Comentar no PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const score = parseInt('${{ steps.check-structure.outputs.score }}');
            const errors = `${{ steps.check-structure.outputs.errors }}`;
            const buildFailed = '${{ steps.build-project.outputs.build_failed }}';
            
            let emoji = '‚≠ê';
            let level = 'Regular';
            let message = '';
            
            if (score >= 90) {
              emoji = 'üåüüåüüåü';
              level = 'Excelente';
              message = 'üéâ Perfeito! Voc√™ dominou os conceitos da Aula 01!';
            } else if (score >= 70) {
              emoji = '‚≠ê‚≠ê';
              level = 'Bom';
              message = '‚úÖ √ìtimo trabalho! Exerc√≠cio aprovado.';
            } else if (score >= 50) {
              emoji = '‚≠ê';
              level = 'Regular';
              message = 'üìù Bom come√ßo, mas precisa de melhorias.';
            } else {
              emoji = '‚ùå';
              level = 'Precisa Melhorar';
              message = 'üîß Revise os requisitos e tente novamente.';
            }
            
            const body = `## ü§ñ Valida√ß√£o Autom√°tica - Aula 01
            
            ### üìä Resultado: **${score}/100** ${emoji}
            **N√≠vel:** ${level}
            
            ${message}
            
            ${errors ? '### ‚ùå Problemas Encontrados:\n' + errors : '### ‚úÖ Todos os requisitos atendidos!'}
            
            ${buildFailed ? '\n‚ö†Ô∏è **Aten√ß√£o:** O projeto n√£o compilou. Verifique os erros no Gradle.\n' : ''}
            
            ${score >= 70 ? '‚úÖ **Exerc√≠cio APROVADO!** Parab√©ns! üéâ' : '‚ùå **Exerc√≠cio REPROVADO.** Score m√≠nimo: 70/100'}
            
            ---
            
            ### üí° Pr√≥ximos Passos:
            ${score >= 70 
              ? '- Continue para a Aula 02: Kotlin Essentials\n- Explore funcionalidades extras para ganhar pontos b√¥nus'
              : '- Corrija os problemas listados acima\n- Fa√ßa commit e push novamente\n- O bot validar√° automaticamente'
            }
            
            ### üìö Recursos √öteis:
            - [Documenta√ß√£o Android](https://developer.android.com)
            - [Kotlin for Android](https://developer.android.com/kotlin)
            - [Slides da Aula 01](https://github.com/petrosbarreto/desenvolvimento-mobile-2026)
            
            ### üÜò Precisa de Ajuda?
            - Abra uma issue com tag \`d√∫vida\`
            - Pergunte no grupo da turma
            - Consulte o [GUIA-PASSO-A-PASSO.md](https://github.com/petrosbarreto/desenvolvimento-mobile-2026-exercicios/blob/main/GUIA-PASSO-A-PASSO.md)
            
            ---
            
            _Valida√ß√£o executada em: ${new Date().toLocaleString('pt-BR', {timeZone: 'America/Recife'})}_  
            _Powered by GitHub Actions ü§ñ_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Definir status do check
        if: steps.check-structure.outputs.score < 70
        run: |
          echo "‚ùå Score abaixo de 70/100. PR precisa de melhorias."
          exit 1
