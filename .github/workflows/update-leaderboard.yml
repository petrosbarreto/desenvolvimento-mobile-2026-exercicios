name: Atualizar Leaderboard (via PRs)

on:
  pull_request:
    types: [opened, synchronize, closed]
    paths:
      - 'exercicios/**'
  schedule:
    - cron: '0 0 * * 1'  # Toda segunda 00:00 UTC
  workflow_dispatch:

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Coletar scores dos PRs
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Buscar todos os PRs (abertos e fechados)
            const allPRs = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'all',
                per_page: 100,
                page
              });
              
              allPRs.push(...prs);
              hasMore = prs.length === 100;
              page++;
            }
            
            console.log(`üìä Total de PRs encontrados: ${allPRs.length}`);
            
            // Coletar exerc√≠cios validados
            const exercicios = [];
            
            for (const pr of allPRs) {
              // Pular PRs de bots
              if (pr.user.login.includes('bot')) continue;
              
              // Detectar qual aula pelo t√≠tulo ou arquivos
              const title = pr.title.toLowerCase();
              let aulaNum = null;
              
              // Extrair n√∫mero da aula do t√≠tulo
              const match = title.match(/aula[_\s-]?(\d+)/i);
              if (match) {
                aulaNum = parseInt(match[1]);
              }
              
              // Se n√£o achou no t√≠tulo, verificar arquivos modificados
              if (!aulaNum) {
                const { data: files } = await github.rest.pulls.listFiles({
                  owner,
                  repo,
                  pull_number: pr.number
                });
                
                for (const file of files) {
                  const fileMatch = file.filename.match(/exercicios\/aula(\d+)\//);
                  if (fileMatch) {
                    aulaNum = parseInt(fileMatch[1]);
                    break;
                  }
                }
              }
              
              if (!aulaNum) continue;
              
              // Buscar check runs (valida√ß√£o autom√°tica)
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: pr.head.sha,
                per_page: 100
              });
              
              // Procurar check de valida√ß√£o da aula
              const validationCheck = checkRuns.check_runs.find(
                run => run.name.includes(`Aula ${String(aulaNum).padStart(2, '0')}`)
              );
              
              let score = 0;
              let aprovado = false;
              
              if (validationCheck) {
                // Extrair score do summary (se dispon√≠vel)
                if (validationCheck.output && validationCheck.output.summary) {
                  const summary = validationCheck.output.summary;
                  const scoreMatch = summary.match(/Score Final:\s*\*?\*?(\d+)\/100/i);
                  
                  if (scoreMatch) {
                    score = parseInt(scoreMatch[1]);
                    aprovado = score >= 70;
                  }
                }
                
                // Se passou o check, consideramos aprovado (m√≠nimo 70)
                if (validationCheck.conclusion === 'success' && score === 0) {
                  score = 70;
                  aprovado = true;
                }
              }
              
              // S√≥ adicionar se foi validado (score > 0)
              if (score > 0) {
                exercicios.push({
                  aluno: pr.user.login,
                  aula: aulaNum,
                  score: score,
                  aprovado: aprovado,
                  prNumber: pr.number,
                  prUrl: pr.html_url,
                  updatedAt: pr.updated_at
                });
                
                console.log(`‚úÖ ${pr.user.login} - Aula ${aulaNum} - Score: ${score}`);
              }
            }
            
            console.log(`\nüìä Total de exerc√≠cios validados: ${exercicios.length}`);
            
            // Agrupar por aluno
            const alunos = new Map();
            
            exercicios.forEach(ex => {
              if (!alunos.has(ex.aluno)) {
                alunos.set(ex.aluno, {
                  nome: ex.aluno,
                  exercicios: [],
                  total: 0,
                  aprovados: 0
                });
              }
              
              const aluno = alunos.get(ex.aluno);
              aluno.exercicios.push(ex);
              aluno.total += ex.score;
              if (ex.aprovado) aluno.aprovados++;
            });
            
            // Ordenar por pontua√ß√£o
            const ranking = Array.from(alunos.values())
              .sort((a, b) => b.total - a.total);
            
            console.log('\nüèÜ Ranking:');
            ranking.forEach((aluno, i) => {
              console.log(`${i+1}. ${aluno.nome} - ${aluno.total} pts (${aluno.exercicios.length} exerc√≠cios)`);
            });
            
            // Salvar dados
            core.setOutput('exercicios_json', JSON.stringify(exercicios));
            core.setOutput('ranking_json', JSON.stringify(ranking));
            
            return { exercicios, ranking };
      
      - name: Gerar HTML do leaderboard
        env:
          EXERCICIOS_DATA: ${{ steps.collect.outputs.exercicios_json }}
          RANKING_DATA: ${{ steps.collect.outputs.ranking_json }}
        run: |
          echo "üé® Gerando leaderboard.html..."
          
          cat > leaderboard.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>üèÜ Ranking - Desenvolvimento Mobile 2026</title>
              <meta http-equiv="refresh" content="300">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container { max-width: 1200px; margin: 0 auto; }
                  header { text-align: center; color: white; margin-bottom: 40px; }
                  h1 { font-size: 3em; margin-bottom: 10px; }
                  .subtitle { font-size: 1.2em; opacity: 0.9; }
                  .stats {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-bottom: 40px;
                  }
                  .stat-card {
                      background: white;
                      padding: 20px;
                      border-radius: 15px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                      text-align: center;
                  }
                  .stat-value { font-size: 2.5em; font-weight: bold; color: #667eea; margin: 10px 0; }
                  .stat-label { color: #666; font-size: 0.9em; }
                  .podium {
                      display: flex;
                      justify-content: center;
                      align-items: flex-end;
                      gap: 20px;
                      margin-bottom: 40px;
                  }
                  .podium-item {
                      background: white;
                      padding: 30px 20px;
                      border-radius: 15px;
                      text-align: center;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                      min-width: 200px;
                      transition: transform 0.3s;
                  }
                  .podium-item:hover { transform: translateY(-10px); }
                  .podium-item.first {
                      order: 2;
                      margin-top: -20px;
                      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
                      color: white;
                  }
                  .podium-item.second {
                      order: 1;
                      background: linear-gradient(135deg, #e0e0e0 0%, #c4c4c4 100%);
                  }
                  .podium-item.third {
                      order: 3;
                      background: linear-gradient(135deg, #cd7f32 0%, #b8793a 100%);
                      color: white;
                  }
                  .medal { font-size: 3em; margin-bottom: 10px; }
                  .ranking-table {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .ranking-row {
                      display: grid;
                      grid-template-columns: 60px 1fr 120px 100px;
                      padding: 15px;
                      border-bottom: 1px solid #eee;
                      align-items: center;
                      gap: 10px;
                  }
                  .ranking-row:hover { background: #f5f5f5; }
                  .position { font-weight: bold; font-size: 1.3em; color: #667eea; }
                  .student-info { }
                  .student-name { font-weight: 600; font-size: 1.1em; margin-bottom: 3px; }
                  .exercises { color: #666; font-size: 0.85em; }
                  .score { font-weight: bold; color: #4caf50; font-size: 1.5em; text-align: right; }
                  .badge {
                      display: inline-block;
                      background: #667eea;
                      color: white;
                      padding: 4px 10px;
                      border-radius: 20px;
                      font-size: 0.75em;
                      margin-left: 8px;
                  }
                  .last-update {
                      text-align: center;
                      color: white;
                      margin-top: 30px;
                      opacity: 0.8;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üèÜ Ranking Geral</h1>
                      <p class="subtitle">Desenvolvimento Mobile 2026.1 - UNIT</p>
                  </header>
                  
                  <div class="stats">
                      <div class="stat-card">
                          <div class="stat-value" id="total-alunos">0</div>
                          <div class="stat-label">Alunos Ativos</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-value">40</div>
                          <div class="stat-label">Exerc√≠cios Totais</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-value" id="media-geral">0</div>
                          <div class="stat-label">M√©dia Geral</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-value" id="prs-aprovados">0</div>
                          <div class="stat-label">PRs Validados</div>
                      </div>
                  </div>
                  
                  <div class="podium" id="podium">
                      <div class="podium-item second">
                          <div class="medal">ü•à</div>
                          <div class="student-name">-</div>
                          <div class="score">0</div>
                      </div>
                      <div class="podium-item first">
                          <div class="medal">ü•á</div>
                          <div class="student-name">-</div>
                          <div class="score">0</div>
                      </div>
                      <div class="podium-item third">
                          <div class="medal">ü•â</div>
                          <div class="student-name">-</div>
                          <div class="score">0</div>
                      </div>
                  </div>
                  
                  <div class="ranking-table">
                      <h2 style="margin-bottom: 20px;">üìä Classifica√ß√£o Completa</h2>
                      <div id="ranking-list"></div>
                  </div>
                  
                  <div class="last-update">
                      √öltima atualiza√ß√£o: <span id="last-update"></span>
                  </div>
              </div>
              
              <script>
                  const RANKING_DATA = INJECT_RANKING_DATA;
                  const EXERCICIOS_DATA = INJECT_EXERCICIOS_DATA;
                  
                  // Atualizar stats
                  document.getElementById('total-alunos').textContent = RANKING_DATA.length;
                  document.getElementById('prs-aprovados').textContent = EXERCICIOS_DATA.length;
                  
                  if (RANKING_DATA.length > 0) {
                      const media = RANKING_DATA.reduce((sum, a) => sum + a.total, 0) / RANKING_DATA.length;
                      document.getElementById('media-geral').textContent = Math.round(media);
                  }
                  
                  // Atualizar p√≥dio
                  if (RANKING_DATA.length >= 1) {
                      document.querySelectorAll('.podium-item.first .student-name')[0].textContent = RANKING_DATA[0].nome;
                      document.querySelectorAll('.podium-item.first .score')[0].textContent = RANKING_DATA[0].total;
                  }
                  if (RANKING_DATA.length >= 2) {
                      document.querySelectorAll('.podium-item.second .student-name')[0].textContent = RANKING_DATA[1].nome;
                      document.querySelectorAll('.podium-item.second .score')[0].textContent = RANKING_DATA[1].total;
                  }
                  if (RANKING_DATA.length >= 3) {
                      document.querySelectorAll('.podium-item.third .student-name')[0].textContent = RANKING_DATA[2].nome;
                      document.querySelectorAll('.podium-item.third .score')[0].textContent = RANKING_DATA[2].total;
                  }
                  
                  // Renderizar ranking
                  const rankingList = document.getElementById('ranking-list');
                  
                  if (RANKING_DATA.length === 0) {
                      rankingList.innerHTML = `
                          <div class="ranking-row">
                              <div class="position">-</div>
                              <div class="student-info">
                                  <div class="student-name">Aguardando primeiro PR validado...</div>
                                  <div class="exercises">Fa√ßa seu exerc√≠cio e envie um Pull Request!</div>
                              </div>
                              <div></div>
                              <div class="score">0</div>
                          </div>
                      `;
                  } else {
                      rankingList.innerHTML = RANKING_DATA.map((aluno, i) => `
                          <div class="ranking-row">
                              <div class="position">#${i + 1}</div>
                              <div class="student-info">
                                  <div class="student-name">
                                      ${aluno.nome}
                                      ${i === 0 ? '<span class="badge">üëë TOP 1</span>' : ''}
                                  </div>
                                  <div class="exercises">
                                      ${aluno.exercicios.length} exerc√≠cio${aluno.exercicios.length !== 1 ? 's' : ''} ‚Ä¢ 
                                      ${aluno.aprovados} aprovado${aluno.aprovados !== 1 ? 's' : ''}
                                  </div>
                              </div>
                              <div class="exercises" style="text-align: center;">
                                  M√©dia: ${Math.round(aluno.total / aluno.exercicios.length)}
                              </div>
                              <div class="score">${aluno.total}</div>
                          </div>
                      `).join('');
                  }
                  
                  // √öltima atualiza√ß√£o
                  document.getElementById('last-update').textContent = new Date().toLocaleString('pt-BR');
              </script>
          </body>
          </html>
          HTMLEOF
          
          # Injetar dados
          RANKING_JSON='${{ steps.collect.outputs.ranking_json }}'
          EXERCICIOS_JSON='${{ steps.collect.outputs.exercicios_json }}'
          
          # Escapar para JSON
          RANKING_JSON=$(echo "$RANKING_JSON" | sed 's/"/\\"/g')
          EXERCICIOS_JSON=$(echo "$EXERCICIOS_JSON" | sed 's/"/\\"/g')
          
          # Substituir placeholders
          sed -i "s|INJECT_RANKING_DATA|$RANKING_JSON|g" leaderboard.html
          sed -i "s|INJECT_EXERCICIOS_DATA|$EXERCICIOS_JSON|g" leaderboard.html
          
          echo "‚úÖ Leaderboard gerado!"
      
      - name: Commit e Push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add leaderboard.html
          
          if git diff --staged --quiet; then
            echo "Nenhuma mudan√ßa no leaderboard"
          else
            git commit -m "üèÜ Atualiza leaderboard (via PRs) [bot]"
            git push
            echo "‚úÖ Leaderboard atualizado!"
          fi
