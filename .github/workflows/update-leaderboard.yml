name: Atualizar Leaderboard

on:
  push:
    branches:
      - main
    paths:
      - 'exercicios/**'
  workflow_dispatch:

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Coletar scores dos exerc√≠cios
        id: collect-scores
        run: |
          echo "üìä Coletando scores dos exerc√≠cios..."
          
          # Criar arquivo tempor√°rio para scores
          > scores.json
          echo "{" >> scores.json
          
          # Para cada pasta de exerc√≠cio
          for ex_dir in exercicios/aula*/*/; do
            if [ -d "$ex_dir" ]; then
              aula=$(echo "$ex_dir" | grep -oP 'aula\d+' | head -1)
              aluno=$(basename "$ex_dir")
              
              # Pular exemplo
              if [[ "$aluno" == *"exemplo"* ]]; then
                continue
              fi
              
              echo "  Verificando: $aula - $aluno"
              
              # Buscar √∫ltimo score nos logs do Actions (simulado por enquanto)
              # Em produ√ß√£o, isso viria dos runs do Actions ou de um arquivo de score
              # Por enquanto, vamos considerar que se a pasta existe, pegou 80 pontos
              
              echo "  \"$aluno-$aula\": {\"aluno\": \"$aluno\", \"aula\": \"$aula\", \"score\": 80}," >> scores.json
            fi
          done
          
          # Fechar JSON
          echo "}" >> scores.json
          
          cat scores.json
      
      - name: Gerar HTML do leaderboard
        run: |
          echo "üé® Gerando HTML do leaderboard..."
          
          # Criar leaderboard.html (vers√£o simplificada por enquanto)
          cat > leaderboard.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>üèÜ Ranking - Desenvolvimento Mobile 2026</title>
              <meta http-equiv="refresh" content="300">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container { max-width: 1200px; margin: 0 auto; }
                  header { text-align: center; color: white; margin-bottom: 40px; }
                  h1 { font-size: 3em; margin-bottom: 10px; }
                  .subtitle { font-size: 1.2em; opacity: 0.9; }
                  .stats {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-bottom: 40px;
                  }
                  .stat-card {
                      background: white;
                      padding: 20px;
                      border-radius: 15px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                      text-align: center;
                  }
                  .stat-value { font-size: 2.5em; font-weight: bold; color: #667eea; margin: 10px 0; }
                  .stat-label { color: #666; font-size: 0.9em; }
                  .podium {
                      display: flex;
                      justify-content: center;
                      align-items: flex-end;
                      gap: 20px;
                      margin-bottom: 40px;
                  }
                  .podium-item {
                      background: white;
                      padding: 30px 20px;
                      border-radius: 15px;
                      text-align: center;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                      min-width: 200px;
                  }
                  .podium-item.first {
                      order: 2;
                      margin-top: -20px;
                      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
                      color: white;
                  }
                  .podium-item.second {
                      order: 1;
                      background: linear-gradient(135deg, #e0e0e0 0%, #c4c4c4 100%);
                  }
                  .podium-item.third {
                      order: 3;
                      background: linear-gradient(135deg, #cd7f32 0%, #b8793a 100%);
                      color: white;
                  }
                  .medal { font-size: 3em; margin-bottom: 10px; }
                  .ranking-table {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .ranking-row {
                      display: grid;
                      grid-template-columns: 50px 1fr 100px 150px;
                      padding: 15px;
                      border-bottom: 1px solid #eee;
                      align-items: center;
                  }
                  .ranking-row:hover { background: #f5f5f5; }
                  .position { font-weight: bold; font-size: 1.2em; color: #667eea; }
                  .student-name { font-weight: 500; }
                  .exercises { color: #666; font-size: 0.9em; }
                  .score { font-weight: bold; color: #4caf50; font-size: 1.3em; }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üèÜ Ranking Geral</h1>
                      <p class="subtitle">Desenvolvimento Mobile 2026.1 - UNIT</p>
                  </header>
                  
                  <div class="stats">
                      <div class="stat-card">
                          <div class="stat-value" id="total-alunos">0</div>
                          <div class="stat-label">Alunos Ativos</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-value">40</div>
                          <div class="stat-label">Exerc√≠cios Totais</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-value" id="media-geral">0</div>
                          <div class="stat-label">M√©dia Geral</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-value" id="prs-aprovados">0</div>
                          <div class="stat-label">PRs Aprovados</div>
                      </div>
                  </div>
                  
                  <div class="podium" id="podium">
                      <div class="podium-item second">
                          <div class="medal">ü•à</div>
                          <div class="student-name">-</div>
                          <div class="score">0</div>
                      </div>
                      <div class="podium-item first">
                          <div class="medal">ü•á</div>
                          <div class="student-name">-</div>
                          <div class="score">0</div>
                      </div>
                      <div class="podium-item third">
                          <div class="medal">ü•â</div>
                          <div class="student-name">-</div>
                          <div class="score">0</div>
                      </div>
                  </div>
                  
                  <div class="ranking-table">
                      <h2 style="margin-bottom: 20px;">üìä Classifica√ß√£o Completa</h2>
                      <div id="ranking-list"></div>
                  </div>
              </div>
              
              <script>
                  // Carregar dados dos exerc√≠cios
                  async function loadRanking() {
                      const rankingList = document.getElementById('ranking-list');
                      const alunos = new Map();
                      
                      // Escanear pastas de exerc√≠cios (simula√ß√£o client-side)
                      // Em produ√ß√£o, isso viria de um scores.json gerado pelo Actions
                      
                      const exercicios = EXERCICIOS_DATA; // Ser√° injetado pelo workflow
                      
                      // Agrupar por aluno
                      exercicios.forEach(ex => {
                          if (!alunos.has(ex.aluno)) {
                              alunos.set(ex.aluno, { nome: ex.aluno, exercicios: [], total: 0 });
                          }
                          alunos.get(ex.aluno).exercicios.push(ex);
                          alunos.get(ex.aluno).total += ex.score;
                      });
                      
                      // Ordenar por pontua√ß√£o
                      const ranking = Array.from(alunos.values())
                          .sort((a, b) => b.total - a.total);
                      
                      // Atualizar stats
                      document.getElementById('total-alunos').textContent = ranking.length;
                      document.getElementById('prs-aprovados').textContent = exercicios.length;
                      
                      if (ranking.length > 0) {
                          const media = ranking.reduce((sum, a) => sum + a.total, 0) / ranking.length;
                          document.getElementById('media-geral').textContent = Math.round(media);
                      }
                      
                      // Atualizar p√≥dio
                      if (ranking.length >= 1) {
                          document.querySelectorAll('.podium-item.first .student-name')[0].textContent = ranking[0].nome;
                          document.querySelectorAll('.podium-item.first .score')[0].textContent = ranking[0].total;
                      }
                      if (ranking.length >= 2) {
                          document.querySelectorAll('.podium-item.second .student-name')[0].textContent = ranking[1].nome;
                          document.querySelectorAll('.podium-item.second .score')[0].textContent = ranking[1].total;
                      }
                      if (ranking.length >= 3) {
                          document.querySelectorAll('.podium-item.third .student-name')[0].textContent = ranking[2].nome;
                          document.querySelectorAll('.podium-item.third .score')[0].textContent = ranking[2].total;
                      }
                      
                      // Renderizar lista
                      if (ranking.length === 0) {
                          rankingList.innerHTML = `
                              <div class="ranking-row">
                                  <div class="position">-</div>
                                  <div class="student-name">?</div>
                                  <div class="exercises">Aguardando primeiro PR...</div>
                                  <div class="score">0</div>
                              </div>
                          `;
                      } else {
                          rankingList.innerHTML = ranking.map((aluno, i) => `
                              <div class="ranking-row">
                                  <div class="position">#${i + 1}</div>
                                  <div class="student-name">${aluno.nome}</div>
                                  <div class="exercises">${aluno.exercicios.length} exerc√≠cios completados</div>
                                  <div class="score">${aluno.total}</div>
                              </div>
                          `).join('');
                      }
                  }
                  
                  // Dados injetados pelo workflow
                  const EXERCICIOS_DATA = INJECT_DATA_HERE;
                  
                  loadRanking();
              </script>
          </body>
          </html>
          EOF
          
          # Injetar dados no HTML
          # Por enquanto, array vazio
          EXERCICIOS_JSON="[]"
          
          # Coletar dados reais dos exerc√≠cios mergeados
          if [ -d "exercicios" ]; then
            EXERCICIOS_JSON="["
            for ex_dir in exercicios/aula*/*/; do
              if [ -d "$ex_dir" ]; then
                aula=$(echo "$ex_dir" | grep -oP 'aula\d+' | head -1)
                aula_num=$(echo "$aula" | grep -oP '\d+')
                aluno=$(basename "$ex_dir")
                
                # Pular exemplo
                if [[ "$aluno" == *"exemplo"* ]]; then
                  continue
                fi
                
                # Adicionar ao JSON (score padr√£o 80 por enquanto)
                EXERCICIOS_JSON="${EXERCICIOS_JSON}{\"aluno\":\"$aluno\",\"aula\":\"$aula_num\",\"score\":80},"
              fi
            done
            
            # Remover √∫ltima v√≠rgula e fechar array
            EXERCICIOS_JSON=$(echo "$EXERCICIOS_JSON" | sed 's/,$//')
            EXERCICIOS_JSON="${EXERCICIOS_JSON}]"
          fi
          
          echo "Dados coletados: $EXERCICIOS_JSON"
          
          # Substituir placeholder
          sed -i "s/INJECT_DATA_HERE/$EXERCICIOS_JSON/" leaderboard.html
          
          echo "‚úÖ Leaderboard gerado!"
      
      - name: Commit e Push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add leaderboard.html
          
          if git diff --staged --quiet; then
            echo "Nenhuma mudan√ßa no leaderboard"
          else
            git commit -m "üèÜ Atualiza leaderboard [bot]"
            git push
            echo "‚úÖ Leaderboard atualizado!"
          fi
